<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Or√ßamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background: linear-gradient(to right, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .supplier-result {
            padding: 10px;
            border: 1px solid #ddd;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 5px;
        }
        .supplier-result:hover {
            background-color: #f8f9fa;
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            padding: 10px;
        }
        .selected-user {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        .selected-cliente {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-center mb-4">üí∞ Cadastro de Or√ßamento</h1>

    <!-- Mensagens de erro/sucesso -->
    <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${param.error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Navega√ß√£o -->
    <div class="mb-4">
        <a th:href="@{/usuarios}" class="btn btn-info">üë§ Ir para Usu√°rios</a>
        <a th:href="@{/clientes}" class="btn btn-success">üë• Ir para Clientes</a>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrcamentoModal">
            ‚ûï Novo Or√ßamento
        </button>
    </div>

    <!-- Tabela de or√ßamentos -->
    <div class="card">
        <div class="card-header">
            <h5>üìã Or√ßamentos Cadastrados</h5>
        </div>
        <div class="card-body">
            <div th:if="${orcamentos != null && orcamentos.empty}" class="text-center text-muted py-4">
                Nenhum or√ßamento cadastrado
            </div>

            <table th:if="${orcamentos != null && !orcamentos.empty}" class="table table-striped">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Descri√ß√£o</th>
                    <th>Valor</th>
                    <th>ICMS</th>
                    <th>Estado</th>
                    <th>Usu√°rio</th>
                    <th>Cliente</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="orcamento : ${orcamentos}">
                    <td th:text="${orcamento.id}"></td>
                    <td th:text="${orcamento.descricao}"></td>
                    <td th:text="${'R$ ' + #numbers.formatDecimal(orcamento.valorOrcamento, 1, 2)}"></td>
                    <td th:text="${'R$ ' + #numbers.formatDecimal(orcamento.valorICMS, 1, 2)}"></td>
                    <td th:text="${orcamento.icmsEstados}"></td>
                    <td th:text="${orcamento.usuario?.nomeUsuario}">-</td>
                    <td th:text="${orcamento.cliente?.nome}">-</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal de Cadastro -->
    <div class="modal fade" id="addOrcamentoModal" tabindex="-1" aria-labelledby="addOrcamentoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/orcamentos}" th:object="${novoOrcamento}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">‚ûï Novo Or√ßamento</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        <!-- SE√á√ÉO USU√ÅRIO -->
                        <div class="mb-3">
                            <label class="form-label">üë§ Usu√°rio:</label>
                            <div class="input-group">
                                <input type="text" id="usuarioSearchTerm" class="form-control" placeholder="Digite o nome do usu√°rio..."/>
                                <button type="button" id="searchUsuarioButton" class="btn btn-outline-secondary">üîç Pesquisar</button>
                            </div>

                            <!-- Resultados da pesquisa -->
                            <div id="usuarioSearchResults" class="search-results mt-2" style="display: none;"></div>

                            <!-- Usu√°rio selecionado -->
                            <div id="selectedUsuarioName" class="selected-user mt-2" style="display: none;">
                                <strong>Usu√°rio Selecionado:</strong>
                                <span id="usuarioNomeText"></span>
                                <button type="button" id="clearUsuario" class="btn btn-sm btn-outline-danger float-end">‚úï</button>
                            </div>

                            <!-- Campo hidden para o ID do usu√°rio -->
                            <input type="hidden" id="idUsuario" th:field="*{usuario.id}"/>
                        </div>

                        <!-- SE√á√ÉO CLIENTE -->
                        <div class="mb-3">
                            <label class="form-label">üë• Cliente:</label>
                            <div class="input-group">
                                <input type="text" id="clienteSearchTerm" class="form-control" placeholder="Digite nome ou CPF do cliente..."/>
                                <button type="button" id="searchClienteButton" class="btn btn-outline-secondary">üîç Pesquisar</button>
                            </div>

                            <!-- Resultados da pesquisa -->
                            <div id="clienteSearchResults" class="search-results mt-2" style="display: none;"></div>

                            <!-- Cliente selecionado -->
                            <div id="selectedClienteName" class="selected-cliente mt-2" style="display: none;">
                                <strong>Cliente Selecionado:</strong>
                                <span id="clienteNomeText"></span>
                                <button type="button" id="clearCliente" class="btn btn-sm btn-outline-danger float-end">‚úï</button>
                            </div>

                            <!-- Campo hidden para o ID do cliente -->
                            <input type="hidden" id="idCliente" th:field="*{cliente.id}"/>
                        </div>

                        <!-- DESCRI√á√ÉO DO SERVI√áO -->
                        <div class="mb-3">
                            <label class="form-label">üìù Descri√ß√£o do Servi√ßo:</label>
                            <input type="text" th:field="*{descricao}" class="form-control"
                                   placeholder="Ex: Desenvolvimento de aplicativo mobile, Reforma de cozinha..."
                                   required>
                            <small class="text-muted">Descreva claramente o servi√ßo a ser realizado</small>
                        </div>

                        <!-- DADOS DO OR√áAMENTO -->
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">üí∞ Valor do Or√ßamento:</label>
                                <input type="number" th:field="*{valorOrcamento}" class="form-control" step="0.01" min="0" required/>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">üèõÔ∏è Estado (ICMS):</label>
                                <select th:field="*{icmsEstados}" class="form-select" required>
                                    <option value="">Selecione o estado</option>
                                    <option value="ICMS_MG">Minas Gerais (18%)</option>
                                    <option value="ICMS_SP">S√£o Paulo (12%)</option>
                                    <option value="ICMS_RJ">Rio de Janeiro (15%)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Campo para mostrar valor do ICMS calculado -->
                        <div class="mt-3">
                            <label class="form-label">üßÆ Valor do ICMS (Calculado Automaticamente):</label>
                            <input type="text" th:field="*{valorICMS}" class="form-control" readonly/>
                            <small class="text-muted">O ICMS ser√° calculado automaticamente quando salvar</small>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">üíæ Salvar Or√ßamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function() {
        console.log("‚úÖ P√°gina de or√ßamentos carregada com sucesso!");

        // ========== FUNCIONALIDADE PARA USU√ÅRIOS ==========
        $('#searchUsuarioButton').click(function() {
            var searchTerm = $('#usuarioSearchTerm').val().trim();

            if (!searchTerm) {
                alert('Digite um nome para pesquisar');
                return;
            }

            console.log("üîç Pesquisando usu√°rio: " + searchTerm);

            $.get('/orcamentos/usuarios/search', { searchTerm: searchTerm })
                .done(function(data) {
                    console.log("‚úÖ Usu√°rios encontrados: ", data);
                    var results = '';

                    if (data.length === 0) {
                        results = '<div class="text-muted">Nenhum usu√°rio encontrado</div>';
                    } else {
                        $.each(data, function(index, usuario) {
                            results += '<div class="supplier-result usuario-result" data-usuario-id="' + usuario.id + '" data-usuario-nome="' + usuario.nomeUsuario + '">'
                                     + '<strong>' + usuario.nomeUsuario + '</strong><br>'
                                     + '<small>CPF: ' + usuario.cpf + ' | RG: ' + usuario.rg + '</small>'
                                     + '</div>';
                        });
                    }

                    $('#usuarioSearchResults').html(results).show();

                    // Configurar clique nos resultados
                    $('.usuario-result').click(function() {
                        var idUsuario = $(this).data('usuario-id');
                        var usuarioNome = $(this).data('usuario-nome');

                        console.log("üë§ Usu√°rio selecionado: " + usuarioNome + " (ID: " + idUsuario + ")");

                        $('#usuarioNomeText').text(usuarioNome);
                        $('#selectedUsuarioName').show();
                        $('#idUsuario').val(idUsuario);

                        $('#usuarioSearchResults').hide().empty();
                        $('#usuarioSearchTerm').val('');

                        // Limpar cliente
                        $('#selectedClienteName').hide();
                        $('#idCliente').val('');
                    });
                })
                .fail(function(error) {
                    console.error("‚ùå Erro na pesquisa de usu√°rios:", error);
                    alert('Erro ao pesquisar usu√°rios');
                });
        });

        $('#clearUsuario').click(function() {
            $('#selectedUsuarioName').hide();
            $('#idUsuario').val('');
            $('#usuarioNomeText').text('');
        });

        // ========== FUNCIONALIDADE PARA CLIENTES ==========
        $('#searchClienteButton').click(function() {
            var searchTerm = $('#clienteSearchTerm').val().trim();

            if (!searchTerm) {
                alert('Digite um nome ou CPF para pesquisar');
                return;
            }

            console.log("üîç Pesquisando cliente: " + searchTerm);

            // Pesquisar por nome
            $.get('/orcamentos/clientes/search', { searchTerm: searchTerm })
                .done(function(data) {
                    console.log("‚úÖ Clientes encontrados por nome: ", data);

                    if (data.length === 0) {
                        // Se n√£o encontrou por nome, pesquisa por CPF
                        console.log("üîç Nenhum resultado por nome, tentando por CPF...");
                        return $.get('/orcamentos/clientes/searchCpf', { searchTerm: searchTerm });
                    }
                    return data;
                })
                .done(function(data) {
                    console.log("‚úÖ Clientes encontrados: ", data);
                    var results = '';

                    if (data.length === 0) {
                        results = '<div class="text-muted">Nenhum cliente encontrado</div>';
                    } else {
                        $.each(data, function(index, cliente) {
                            results += '<div class="supplier-result cliente-result" data-cliente-id="' + cliente.id + '" data-cliente-nome="' + cliente.nome + '">'
                                     + '<strong>' + cliente.nome + '</strong><br>'
                                     + '<small>CPF: ' + cliente.cpf + '</small>'
                                     + '</div>';
                        });
                    }

                    $('#clienteSearchResults').html(results).show();

                    // Configurar clique nos resultados
                    $('.cliente-result').click(function() {
                        var idCliente = $(this).data('cliente-id');
                        var clienteNome = $(this).data('cliente-nome');

                        console.log("üë• Cliente selecionado: " + clienteNome + " (ID: " + idCliente + ")");

                        $('#clienteNomeText').text(clienteNome);
                        $('#selectedClienteName').show();
                        $('#idCliente').val(idCliente);

                        $('#clienteSearchResults').hide().empty();
                        $('#clienteSearchTerm').val('');

                        // Limpar usu√°rio
                        $('#selectedUsuarioName').hide();
                        $('#idUsuario').val('');
                    });
                })
                .fail(function(error) {
                    console.error("‚ùå Erro na pesquisa de clientes:", error);
                    alert('Erro ao pesquisar clientes');
                });
        });

        $('#clearCliente').click(function() {
            $('#selectedClienteName').hide();
            $('#idCliente').val('');
            $('#clienteNomeText').text('');
        });

        // Fechar resultados ao clicar fora
        $(document).click(function(e) {
            if (!$(e.target).closest('#usuarioSearchResults, #searchUsuarioButton, #usuarioSearchTerm').length) {
                $('#usuarioSearchResults').hide();
            }
            if (!$(e.target).closest('#clienteSearchResults, #searchClienteButton, #clienteSearchTerm').length) {
                $('#clienteSearchResults').hide();
            }
        });

        // Limpar modal quando fechar
        $('#addOrcamentoModal').on('hidden.bs.modal', function () {
            $('#selectedUsuarioName').hide();
            $('#idUsuario').val('');
            $('#usuarioSearchResults').hide().empty();
            $('#usuarioSearchTerm').val('');

            $('#selectedClienteName').hide();
            $('#idCliente').val('');
            $('#clienteSearchResults').hide().empty();
            $('#clienteSearchTerm').val('');
        });
    });
</script>
</body>
</html>